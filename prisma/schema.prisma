generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  extensions = [vector]
}

model User {
  id            String         @id @map("idND")
  name          String         @map("hoTen")
  email         String         @unique @map("email")
  emailVerified Boolean        @default(false) @map("daXacThucEmail")
  image         String?        @map("anhDaiDien")
  createdAt     DateTime       @default(now()) @map("ngayTao")
  updatedAt     DateTime       @updatedAt @map("ngayCapNhat")
  khoaHocs      KhoaHoc[]
  sessions      Session[]
  accounts      Account[]
  dangKyHocs    DangKyHoc[]
  tienTrinhHocs TienTrinhHoc[]
  tinNhans      TinNhan[]
  role          String?        @map("vaiTro")
  banned        Boolean?       @default(false) @map("biCam")
  banReason     String?        @map("lyDoCam")
  banExpires    DateTime?      @map("hetHanCam")

  isPremium      Boolean   @default(false) @map("is_premium")
  premiumExpires DateTime? @map("han_su_dung_premium")

  thanhToanPremiums ThanhToanPremium[]
  
  // Comment relations
  binhLuans         BinhLuan[]
  baoCaoBinhLuans   BaoCaoBinhLuan[]
  
  // Rating relations
  danhGias          DanhGia[]

  @@map("nguoiDung")
}



model Session {
  id        String   @id @map("idPhien")
  expiresAt DateTime @map("hetHan")
  token     String   @unique @map("maToken")
  createdAt DateTime @default(now()) @map("ngayTao")
  updatedAt DateTime @updatedAt @map("ngayCapNhat")
  ipAddress String?  @map("diaChiIP")
  userAgent String?  @map("trangThaiNguoiDung")

  userId String @map("idNguoiDung")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  impersonatedBy String? @map("biMaoDanh")

  @@index([userId])
  @@map("phienDangNhap")
}

model Account {
  id         String @id @map("idTK")
  accountId  String @map("maTaiKhoan")
  providerId String @map("maNhaCungCap")

  userId String @map("idNguoiDung")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  accessToken           String?   @map("maToken")
  refreshToken          String?   @map("maLamMoiToken")
  idToken               String?   @map("idToken")
  accessTokenExpiresAt  DateTime? @map("maTokenHetHan")
  refreshTokenExpiresAt DateTime? @map("maLamMoiTokenHetHan")
  scope                 String?   @map("phamVi")
  password              String?   @map("matKhau")

  createdAt DateTime @default(now()) @map("ngayTao")
  updatedAt DateTime @updatedAt @map("ngayCapNhat")

  @@index([userId])
  @@map("taiKhoan")
}

model Verification {
  id         String   @id @map("idXM")
  identifier String   @map("maDinhDanh")
  value      String   @map("giaTri")
  expiresAt  DateTime @map("hetHan")
  createdAt  DateTime @default(now()) @map("ngayTao")
  updatedAt  DateTime @updatedAt @map("ngayCapNhat")

  @@index([identifier])
  @@map("xacMinh")
}

model KhoaHoc {
  id                String             @id @default(uuid())
  tenKhoaHoc        String
  moTa              String
  tepKH             String
  gia               Int
  thoiLuong         Int
  // Old fields (will be deprecated after migration)
  capDo             CapDoKhoaHocEnum?       @default(NguoiMoi)
  danhMuc           String?
  trangThai         TrangThaiKhoaHocEnum?   @default(BanNhap) @map("trangThai") // Renamed enum to avoid conflict with model
  
  // New Vietnamese relations
  idDanhMuc         String?             @map("id_danh_muc")
  danhMucRef        DanhMuc?            @relation(fields: [idDanhMuc], references: [id])
  
  idCapDo           String?             @map("id_cap_do")
  capDoRef          CapDo?              @relation(fields: [idCapDo], references: [id])
  
  idTrangThai       String?             @map("id_trang_thai")
  trangThaiRef      TrangThaiKhoaHoc?   @relation(fields: [idTrangThai], references: [id])

  moTaNgan          String
  duongDan          String             @unique
  ngayTao           DateTime           @default(now())
  ngayCapNhat       DateTime           @updatedAt
  dangKyHocs        DangKyHoc[]
  idNguoiDung       String
  nguoiDung         User               @relation(fields: [idNguoiDung], references: [id], onDelete: Cascade)
  chuongs           Chuong[]
  maGiamGiaKhoaHocs MaGiamGiaKhoaHoc[]
  
  phongChat         PhongChat?
  
  // Rating relations
  danhGias          DanhGia[]

  @@map("khoaHoc")
  @@index([idDanhMuc])
  @@index([idCapDo])
  @@index([idTrangThai])
}

enum CapDoKhoaHocEnum {
  NguoiMoi
  TrungCap
  NangCao
}

enum TrangThaiKhoaHocEnum {
  BanNhap
  BanChinhThuc
  BanLuuTru
}

model DanhMuc {
  id            String     @id @default(uuid())
  tenDanhMuc    String     @map("ten_danh_muc")
  duongDan      String     @unique @map("duong_dan") // slug
  idDanhMucCha  String?    @map("id_danh_muc_cha")
  danhMucCha    DanhMuc?   @relation("DanhMucCon", fields: [idDanhMucCha], references: [id])
  danhMucCon    DanhMuc[]  @relation("DanhMucCon")
  khoaHocs      KhoaHoc[]
  
  ngayTao       DateTime   @default(now()) @map("ngay_tao")
  ngayCapNhat   DateTime   @updatedAt @map("ngay_cap_nhat")

  @@map("danh_muc")
  @@index([idDanhMucCha])
}

model CapDo {
  id            String     @id @default(uuid())
  tenCapDo      String     @map("ten_cap_do")
  maCapDo       String     @unique @map("ma_cap_do") // e.g. 'NGUOI_MOI', 'TRUNG_CAP'
  khoaHocs      KhoaHoc[]
  
  ngayTao       DateTime   @default(now()) @map("ngay_tao")
  ngayCapNhat   DateTime   @updatedAt @map("ngay_cap_nhat")

  @@map("cap_do")
}

model TrangThaiKhoaHoc {
  id            String     @id @default(uuid())
  tenTrangThai  String     @map("ten_trang_thai")
  maTrangThai   String     @unique @map("ma_trang_thai") 
  khoaHocs      KhoaHoc[]
  
  ngayTao       DateTime   @default(now()) @map("ngay_tao")
  ngayCapNhat   DateTime   @updatedAt @map("ngay_cap_nhat")

  @@map("trang_thai_khoa_hoc")
}

model Chuong {
  id          String   @id @default(uuid())
  tenChuong   String
  thuTu       Int
  ngayTao     DateTime @default(now())
  ngayCapNhat DateTime @updatedAt

  baiHocs   BaiHoc[]
  idKhoaHoc String
  khoaHoc   KhoaHoc  @relation(fields: [idKhoaHoc], references: [id], onDelete: Cascade)

  @@index([idKhoaHoc])
  @@map("chuong")
}

model BaiHoc {
  id            String         @id @default(uuid())
  tenBaiHoc     String
  moTa          String?
  anhBaiHoc     String?
  maVideo       String?
  embedding     Unsupported("vector(768)")?
  thuTu         Int
  thoiLuong     Int?
  mienPhi       Boolean?       @default(false)
  ngayTao       DateTime       @default(now())
  ngayCapNhat   DateTime       @updatedAt
  idChuong      String
  chuong        Chuong         @relation(fields: [idChuong], references: [id], onDelete: Cascade)
  tienTrinhHocs TienTrinhHoc[]
  binhLuans     BinhLuan[]

  @@index([idChuong])
  @@map("baiHoc")
}

model DangKyHoc {
  id            String          @id @default(uuid())
  soTien        Int             // Tổng tiền người dùng trả (Gross)
  phiSan        Int             @default(0) @map("phi_san")        // Phí Admin thu (5%)
  thanhToanThuc Int             @default(0) @map("thanh_toan_thuc") // Tiền GV nhận (95%)
  trangThai     TrangThaiDangKy @default(DangXuLy)
  camChat       Boolean         @default(false)
  ngayTao       DateTime        @default(now())
  ngayCapNhat   DateTime        @updatedAt

  idKhoaHoc String
  khoaHoc   KhoaHoc @relation(fields: [idKhoaHoc], references: [id], onDelete: Cascade)

  idNguoiDung String
  nguoiDung   User   @relation(fields: [idNguoiDung], references: [id], onDelete: Cascade)

  maGiamGiaId String?
  maGiamGia   maGiamGia? @relation(fields: [maGiamGiaId], references: [id])

  @@unique([idNguoiDung, idKhoaHoc])
  @@index([idKhoaHoc])
  @@index([idNguoiDung])
  @@index([maGiamGiaId])
  @@map("dangKyHoc")
}

enum TrangThaiDangKy {
  DangXuLy
  DaThanhToan
  DaHuy
}

enum LoaiTinNhan {
  USER
  SYSTEM
}

enum LoaiGiamGia {
  PhanTram
  GiamTien
}

model TienTrinhHoc {
  id          String   @id @default(uuid())
  hoanThanh   Boolean  @default(false)
  ngayTao     DateTime @default(now())
  ngayCapNhat DateTime @updatedAt

  idNguoiDung String
  nguoiDung   User   @relation(fields: [idNguoiDung], references: [id], onDelete: Cascade)

  idBaiHoc String
  baiHoc   BaiHoc @relation(fields: [idBaiHoc], references: [id], onDelete: Cascade)

  @@unique([idNguoiDung, idBaiHoc])
  @@map("tienTrinhHoc")
}

model maGiamGia {
  id         String    @id @default(uuid())
  ngayTao    DateTime  @default(now())
  ngayBatDau DateTime? 
  ngayKetThuc DateTime?
  tieuDe      String
  soLuong     Int
  maGiamGia   String      @unique
  hoatDong    Boolean
  daSuDung    Int         @default(0)
  loai        LoaiGiamGia
  giaTri      Int

  maGiamGiaKhoaHocs MaGiamGiaKhoaHoc[]
  dangKyHocs        DangKyHoc[]
}

model MaGiamGiaKhoaHoc {
  id          String @id @default(uuid())
  maGiamGiaId String
  khoaHocId   String

  maGiamGia maGiamGia @relation(fields: [maGiamGiaId], references: [id], onDelete: Cascade)
  khoaHoc   KhoaHoc   @relation(fields: [khoaHocId], references: [id], onDelete: Cascade)

  @@index([maGiamGiaId])
  @@index([khoaHocId])
  @@map("ma_giam_gia_khoa_hoc")
}

model PhongChat {
  id        String   @id @default(uuid())
  tenPhong  String?
  maMoi     String   @unique @default(uuid())
  
  khoaHocId String   @unique
  khoaHoc   KhoaHoc  @relation(fields: [khoaHocId], references: [id], onDelete: Cascade)
  
  tinNhans  TinNhan[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("phongChat")
}

model TinNhan {
  id        String   @id @default(uuid())
  noiDung   String   @db.Text
  fileUrl   String?
  fileType  String?
  fileName  String?
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  phongChatId String
  phongChat   PhongChat @relation(fields: [phongChatId], references: [id], onDelete: Cascade)
  
  isDeleted Boolean  @default(false)
  loaiTinNhan LoaiTinNhan @default(USER)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([phongChatId])
  @@index([userId])
  @@map("tinNhan")
}


model ThanhToanPremium {
  id               String            @id @default(uuid())
  soTien           Int               // 99000 VND
  soNgay           Int               @default(30) @map("so_ngay") // 30 days
  trangThai        TrangThaiDangKy   @default(DangXuLy)
  
  // VNPay transaction tracking
  vnpTxnRef        String?           @map("vnp_txn_ref")
  vnpTransactionNo String?           @map("vnp_transaction_no")
  vnpBankCode      String?           @map("vnp_bank_code")
  
  idNguoiDung      String            @map("id_nguoi_dung")
  nguoiDung        User              @relation(fields: [idNguoiDung], references: [id], onDelete: Cascade)
  
  ngayTao          DateTime          @default(now()) @map("ngay_tao")
  ngayCapNhat      DateTime          @updatedAt @map("ngay_cap_nhat")
  
  @@index([idNguoiDung])
  @@index([trangThai])
  @@map("thanh_toan_premium")
}


enum TrangThaiBinhLuan {
  HIEN       // Visible (default)
  AN         // Hidden (reported)
  DA_XOA     // Soft-deleted
}

enum TrangThaiBaoCao {
  ChoXuLy    // Pending
  DaXuLy     // Processed  
  TuChoi     // Rejected
}

model BinhLuan {
  id            String             @id @default(uuid()) @map("idBL")
  capDo         Int                @default(0) // 0 = root comment, 1 = reply (max 2 levels)
  noiDung       String             @db.Text
  trangThai     TrangThaiBinhLuan  @default(HIEN)
  
  idNguoiDung   String             @map("idND")
  nguoiDung     User               @relation(fields: [idNguoiDung], references: [id], onDelete: Cascade)
  
  idBaiHoc      String             @map("idBH")
  baiHoc        BaiHoc             @relation(fields: [idBaiHoc], references: [id], onDelete: Cascade)
  
  idKhoaHoc     String             @map("idKH")
  
  idCha         String?            @map("idCha")
  parent        BinhLuan?          @relation("BinhLuanReplies", fields: [idCha], references: [id], onDelete: Cascade)
  replies       BinhLuan[]         @relation("BinhLuanReplies")
  
  // Reports
  baoCaos       BaoCaoBinhLuan[]
  
  ngayTao       DateTime           @default(now())
  ngayCapNhat   DateTime           @updatedAt
  
  @@index([idBaiHoc])
  @@index([idNguoiDung])
  @@index([idKhoaHoc])
  @@index([idCha])
  @@map("binhLuan")
}

model BaoCaoBinhLuan {
  id            String           @id @default(uuid())
  lyDo          String           @db.Text
  
  // Reporter
  idNguoiDung   String           @map("idND")
  nguoiDung     User             @relation(fields: [idNguoiDung], references: [id], onDelete: Cascade)
  
  // Reported comment
  idBinhLuan    String           @map("idBL")
  binhLuan      BinhLuan         @relation(fields: [idBinhLuan], references: [id], onDelete: Cascade)
  
  trangThai     TrangThaiBaoCao  @default(ChoXuLy)
  ngayTao       DateTime         @default(now())
  
  // User can only report a comment once
  @@unique([idNguoiDung, idBinhLuan])
  @@index([idBinhLuan])
  @@map("baoCaoBinhLuan")
}

// ==================== ĐÁNH GIÁ KHÓA HỌC ====================

enum TrangThaiDanhGia {
  HIEN       // Visible (default)
  AN         // Hidden (spam/violating)
}

model DanhGia {
  id            String            @id @default(uuid()) @map("idDG")
  diemDanhGia   Int               // 1-5 stars
  noiDung       String?           @db.Text
  trangThai     TrangThaiDanhGia  @default(HIEN)
  
  idNguoiDung   String            @map("idND")
  nguoiDung     User              @relation(fields: [idNguoiDung], references: [id], onDelete: Cascade)
  
  idKhoaHoc     String            @map("idKH")
  khoaHoc       KhoaHoc           @relation(fields: [idKhoaHoc], references: [id], onDelete: Cascade)
  
  ngayTao       DateTime          @default(now())
  ngayCapNhat   DateTime          @updatedAt
  
  // Each user can only rate a course once
  @@unique([idNguoiDung, idKhoaHoc])
  @@index([idKhoaHoc])
  @@index([idNguoiDung])
  @@map("danhGia")
}
