generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  extensions = [vector]
}

model User {
  id            String         @id @map("idND")
  name          String         @map("hoTen")
  email         String         @unique @map("email")
  emailVerified Boolean        @default(false) @map("daXacThucEmail")
  image         String?        @map("anhDaiDien")
  createdAt     DateTime       @default(now()) @map("ngayTao")
  updatedAt     DateTime       @updatedAt @map("ngayCapNhat")
  password      String?        @map("matKhau")
  khoaHocs      KhoaHoc[]
  sessions      Session[]
  accounts      Account[]
  dangKyHocs    DangKyHoc[]
  tienTrinhHocs TienTrinhHoc[]
  tinNhans      TinNhan[]
  role          String?        @map("vaiTro")
  banned        Boolean?       @default(false) @map("biCam")
  banReason     String?        @map("lyDoCam")
  banExpires    DateTime?      @map("hetHanCam")

  @@map("nguoiDung")
}

model Session {
  id        String   @id @map("idPhien")
  expiresAt DateTime @map("hetHan")
  token     String   @unique @map("maToken")
  createdAt DateTime @default(now()) @map("ngayTao")
  updatedAt DateTime @updatedAt @map("ngayCapNhat")
  ipAddress String?  @map("diaChiIP")
  userAgent String?  @map("trangThaiNguoiDung")

  userId String @map("idNguoiDung")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  impersonatedBy String? @map("biMaoDanh")

  @@index([userId])
  @@map("phienDangNhap")
}

model Account {
  id         String @id @map("idTK")
  accountId  String @map("maTaiKhoan")
  providerId String @map("maNhaCungCap")

  userId String @map("idNguoiDung")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  accessToken           String?   @map("maToken")
  refreshToken          String?   @map("maLamMoiToken")
  idToken               String?   @map("idToken")
  accessTokenExpiresAt  DateTime? @map("maTokenHetHan")
  refreshTokenExpiresAt DateTime? @map("maLamMoiTokenHetHan")
  scope                 String?   @map("phamVi")
  password              String?   @map("matKhau")

  createdAt DateTime @default(now()) @map("ngayTao")
  updatedAt DateTime @updatedAt @map("ngayCapNhat")

  @@index([userId])
  @@map("taiKhoan")
}

model Verification {
  id         String   @id @map("idXM")
  identifier String   @map("maDinhDanh")
  value      String   @map("giaTri")
  expiresAt  DateTime @map("hetHan")
  createdAt  DateTime @default(now()) @map("ngayTao")
  updatedAt  DateTime @updatedAt @map("ngayCapNhat")

  @@index([identifier])
  @@map("xacMinh")
}

model KhoaHoc {
  id                String             @id @default(uuid())
  tenKhoaHoc        String
  moTa              String
  tepKH             String
  gia               Int
  thoiLuong         Int
  // Old fields (will be deprecated after migration)
  capDo             CapDoKhoaHocEnum?       @default(NguoiMoi)
  danhMuc           String?
  trangThai         TrangThaiKhoaHocEnum?   @default(BanNhap) @map("trangThai") // Renamed enum to avoid conflict with model
  
  // New Vietnamese relations
  idDanhMuc         String?             @map("id_danh_muc")
  danhMucRef        DanhMuc?            @relation(fields: [idDanhMuc], references: [id])
  
  idCapDo           String?             @map("id_cap_do")
  capDoRef          CapDo?              @relation(fields: [idCapDo], references: [id])
  
  idTrangThai       String?             @map("id_trang_thai")
  trangThaiRef      TrangThaiKhoaHoc?   @relation(fields: [idTrangThai], references: [id])

  moTaNgan          String
  duongDan          String             @unique
  ngayTao           DateTime           @default(now())
  ngayCapNhat       DateTime           @updatedAt
  dangKyHocs        DangKyHoc[]
  idNguoiDung       String
  nguoiDung         User               @relation(fields: [idNguoiDung], references: [id], onDelete: Cascade)
  chuongs           Chuong[]
  maGiamGiaKhoaHocs MaGiamGiaKhoaHoc[]
  
  phongChat         PhongChat?

  @@map("khoaHoc")
  @@index([idDanhMuc])
  @@index([idCapDo])
  @@index([idTrangThai])
}

enum CapDoKhoaHocEnum {
  NguoiMoi
  TrungCap
  NangCao
}

enum TrangThaiKhoaHocEnum {
  BanNhap
  BanChinhThuc
  BanLuuTru
}

model DanhMuc {
  id            String     @id @default(uuid())
  tenDanhMuc    String     @map("ten_danh_muc")
  duongDan      String     @unique @map("duong_dan") // slug
  idDanhMucCha  String?    @map("id_danh_muc_cha")
  danhMucCha    DanhMuc?   @relation("DanhMucCon", fields: [idDanhMucCha], references: [id])
  danhMucCon    DanhMuc[]  @relation("DanhMucCon")
  khoaHocs      KhoaHoc[]
  
  ngayTao       DateTime   @default(now()) @map("ngay_tao")
  ngayCapNhat   DateTime   @updatedAt @map("ngay_cap_nhat")

  @@map("danh_muc")
  @@index([idDanhMucCha])
}

model CapDo {
  id            String     @id @default(uuid())
  tenCapDo      String     @map("ten_cap_do")
  maCapDo       String     @unique @map("ma_cap_do") // e.g. 'NGUOI_MOI', 'TRUNG_CAP'
  khoaHocs      KhoaHoc[]
  
  ngayTao       DateTime   @default(now()) @map("ngay_tao")
  ngayCapNhat   DateTime   @updatedAt @map("ngay_cap_nhat")

  @@map("cap_do")
}

model TrangThaiKhoaHoc {
  id            String     @id @default(uuid())
  tenTrangThai  String     @map("ten_trang_thai")
  maTrangThai   String     @unique @map("ma_trang_thai") // e.g. 'DRAFT', 'PUBLISHED'
  khoaHocs      KhoaHoc[]
  
  ngayTao       DateTime   @default(now()) @map("ngay_tao")
  ngayCapNhat   DateTime   @updatedAt @map("ngay_cap_nhat")

  @@map("trang_thai_khoa_hoc")
}

model Chuong {
  id          String   @id @default(uuid())
  tenChuong   String
  thuTu       Int
  ngayTao     DateTime @default(now())
  ngayCapNhat DateTime @updatedAt

  baiHocs   BaiHoc[]
  idKhoaHoc String
  khoaHoc   KhoaHoc  @relation(fields: [idKhoaHoc], references: [id], onDelete: Cascade)

  @@index([idKhoaHoc])
  @@map("chuong")
}

model BaiHoc {
  id            String         @id @default(uuid())
  tenBaiHoc     String
  moTa          String?
  anhBaiHoc     String?
  maVideo       String?
  embedding     Unsupported("vector(768)")?
  thuTu         Int
  thoiLuong     Int?
  mienPhi       Boolean?       @default(false)
  ngayTao       DateTime       @default(now())
  ngayCapNhat   DateTime       @updatedAt
  idChuong      String
  chuong        Chuong         @relation(fields: [idChuong], references: [id], onDelete: Cascade)
  tienTrinhHocs TienTrinhHoc[]

  @@index([idChuong])
  @@map("baiHoc")
}

model DangKyHoc {
  id          String          @id @default(uuid())
  soTien      Int
  trangThai   TrangThaiDangKy @default(DangXuLy)
  camChat     Boolean         @default(false)
  ngayTao     DateTime        @default(now())
  ngayCapNhat DateTime        @updatedAt

  idKhoaHoc String
  khoaHoc   KhoaHoc @relation(fields: [idKhoaHoc], references: [id], onDelete: Cascade)

  idNguoiDung String
  nguoiDung   User   @relation(fields: [idNguoiDung], references: [id], onDelete: Cascade)

  maGiamGiaId String?
  maGiamGia   maGiamGia? @relation(fields: [maGiamGiaId], references: [id])

  @@unique([idNguoiDung, idKhoaHoc])
  @@index([idKhoaHoc])
  @@index([idNguoiDung])
  @@index([maGiamGiaId])
  @@map("dangKyHoc")
}

enum TrangThaiDangKy {
  DangXuLy
  DaThanhToan
  DaHuy
}

enum LoaiTinNhan {
  USER
  SYSTEM
}

enum LoaiGiamGia {
  PhanTram
  GiamTien
}

model TienTrinhHoc {
  id          String   @id @default(uuid())
  hoanThanh   Boolean  @default(false)
  ngayTao     DateTime @default(now())
  ngayCapNhat DateTime @updatedAt

  idNguoiDung String
  nguoiDung   User   @relation(fields: [idNguoiDung], references: [id], onDelete: Cascade)

  idBaiHoc String
  baiHoc   BaiHoc @relation(fields: [idBaiHoc], references: [id], onDelete: Cascade)

  @@unique([idNguoiDung, idBaiHoc])
  @@map("tienTrinhHoc")
}

model maGiamGia {
  id         String    @id @default(uuid())
  ngayTao    DateTime  @default(now())
  ngayBatDau DateTime? 
  ngayKetThuc DateTime?
  tieuDe      String
  soLuong     Int
  maGiamGia   String      @unique
  hoatDong    Boolean
  daSuDung    Int         @default(0)
  loai        LoaiGiamGia
  giaTri      Int

  maGiamGiaKhoaHocs MaGiamGiaKhoaHoc[]
  dangKyHocs        DangKyHoc[]
}

model MaGiamGiaKhoaHoc {
  id          String @id @default(uuid())
  maGiamGiaId String
  khoaHocId   String

  maGiamGia maGiamGia @relation(fields: [maGiamGiaId], references: [id], onDelete: Cascade)
  khoaHoc   KhoaHoc   @relation(fields: [khoaHocId], references: [id], onDelete: Cascade)

  @@index([maGiamGiaId])
  @@index([khoaHocId])
  @@map("ma_giam_gia_khoa_hoc")
}

model PhongChat {
  id        String   @id @default(uuid())
  tenPhong  String?
  maMoi     String   @unique @default(uuid())
  
  khoaHocId String   @unique
  khoaHoc   KhoaHoc  @relation(fields: [khoaHocId], references: [id], onDelete: Cascade)
  
  tinNhans  TinNhan[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("phongChat")
}

model TinNhan {
  id        String   @id @default(uuid())
  noiDung   String   @db.Text
  fileUrl   String?
  fileType  String?
  fileName  String?
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  phongChatId String
  phongChat   PhongChat @relation(fields: [phongChatId], references: [id], onDelete: Cascade)
  
  isDeleted Boolean  @default(false)
  loaiTinNhan LoaiTinNhan @default(USER)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([phongChatId])
  @@index([userId])
  @@map("tinNhan")
}
